# æ·±åº¦å­¦ä¹ å®æˆ˜  
## å®è·µä¸€ï¼šBPç¥ç»ç½‘ç»œçš„numpyå®ç°  
ä»»åŠ¡æ–‡ä»¶å¤¹ numpy_halfmoon  
### ç½‘ç»œå‚æ•°ï¼š  
```Bash
epoch 5000
éšè—å±‚ç¥ç»å…ƒä¸ªæ•° 10
learning_rate 0.1
æ­£åˆ™åŒ–æ¯”ä¾‹Î» 0.001
```  
### è¿è¡Œç»“æœ
![numpy_halfmoon](numpy_halfmoon/pic/Figure_4.png)
## å®è·µäºŒï¼šåŸºäºnumpyå®ç°BPç¥ç»ç½‘ç»œçš„mnistå›¾åƒåˆ†ç±»  
ä»»åŠ¡æ–‡ä»¶å¤¹ numpy_MNIST  
### ç½‘ç»œå‚æ•°ï¼š  
```Bash  
epoch 400
éšè—å±‚ç¥ç»å…ƒä¸ªæ•° 1024
learning_rate 0.2
decay_rate 0.98
æ­£åˆ™åŒ–æ¯”ä¾‹Î» 0.01
æ¿€æ´»å‡½æ•°_relu
æŸå¤±å‡½æ•° svm_loss
ä½¿ç”¨ä½™å¼¦é€€ç«+warmup
```
### è¿è¡Œç»“æœ
![](numpy_MNIST/pic/Figure_2.png)
![](numpy_MNIST/pic/Figure_1.png)
```bash
result:  
Epoch 399: Loss = 0.2081
Accuracy = 0.9603
Test loss = 0.2226
Test accuracy = 0.9568
``` 
### å°è¯•è¿‡ç¨‹  
- æŸå¤±å‡½æ•°ï¼š  å°è¯•ä½¿ç”¨äº¤å‰ç†µæŸå¤±ï¼ŒmseæŸå¤±ï¼ŒsvmæŸå¤±ã€‚å…¶ä¸­svmæŸå¤±æ•ˆæœæœ€å¥½ã€‚    
- æ¿€æ´»å‡½æ•°ï¼š  å°è¯•ä½¿ç”¨sigmoidï¼Œreluã€‚reluæ”¶æ•›é€Ÿåº¦æå¿«ï¼Œè®­ç»ƒé€Ÿåº¦å¿«ï¼Œæ•ˆæœæœ€å¥½ã€‚  
- å­¦ä¹ ç‡ï¼š    è¿‡å¤§æ¨¡å‹æ— æ³•æ”¶æ•›ï¼Œè¿‡å°æ”¶æ•›é€Ÿåº¦è¾ƒæ…¢ï¼Œä¸”å‡ºç°â€œæ¶Œç°ç°è±¡â€ï¼Œå³åœ¨è®­ç»ƒä¸€äº›epochålossçªç„¶å¤§å¹…åº¦ä¸‹é™ã€‚  
- decayï¼š     å­¦ä¹ ç‡è¡°å‡å½±å“ä¸å¤§ã€‚  
- æ­£åˆ™åŒ–ï¼š    ä½¿ç”¨è¿‡å¤§æ­£åˆ™åŒ–ä¼šå¯¼è‡´æ¨¡å‹æ— æ³•æ”¶æ•›è‡³æœ€ä¼˜ã€‚  
- hidden neuron size:     è¿‡å¤§æ— æ˜æ˜¾æå‡ä¸”è®­ç»ƒé€Ÿåº¦å¤§å¹…åº¦ä¸‹é™ï¼Œè¿‡å°æœ€ä¼˜ç‚¹æ•ˆæœä¸ä½³ã€‚
## å®è·µä¸‰ï¼šåŸºäºpytorchçš„mnistå›¾åƒåˆ†ç±»  
ä»»åŠ¡æ–‡ä»¶å¤¹ pytorch_MNIST  
### è¿è¡Œç»“æœ
| æ¨¡å‹ | Epoch | Loss | Accuracy |
| --- | --- | --- | --- |
| LeNet | 10 | 0.0011 | 99.17% |
| VGG | 10 | 0.0261 | 98.57% |
| ResNet-18 | 10 | 0.0128 | 99.42% |
| ViT (not-full converge) | 50 | - | 97.14% |
| ViT (without sqrt(d)) | 50 | - | 97.15% |

LeNet:
![LeNet](pytorch_MNIST/pic/LeNet.png)
VGG:
![VGG](pytorch_MNIST/pic/VGG.png)
ResNet-18:
![ResNet-18](pytorch_MNIST/pic/Res18.png)
ViT:
![ViT](pytorch_MNIST/pic/ViT.png)


### æ¨¡å‹ç‰¹ç‚¹å¯¹æ¯”

| æ¨¡å‹ | ç‰¹ç‚¹ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
| --- | --- | --- | --- |
| LeNet | ç»å…¸çš„æµ…å±‚å·ç§¯ç¥ç»ç½‘ç»œï¼ŒåŒ…å«å°‘é‡å·ç§¯å±‚å’Œå…¨è¿æ¥å±‚ã€‚ | ç»“æ„ç®€å•ï¼Œé€‚åˆå°è§„æ¨¡æ•°æ®é›†ï¼Œè®¡ç®—é€Ÿåº¦å¿« | è¡¨è¾¾èƒ½åŠ›æœ‰é™ï¼Œéš¾ä»¥å¤„ç†æ›´å¤æ‚çš„å›¾åƒä»»åŠ¡ |
| VGG-11 | æ·±å±‚å·ç§¯ç½‘ç»œï¼Œé‡‡ç”¨å¤šä¸ª 3x3 å·ç§¯æ ¸å †å ï¼Œé…åˆæ± åŒ–å±‚æé«˜ç‰¹å¾æå–æ•ˆæœã€‚ | è¾ƒå¼ºçš„ç‰¹å¾è¡¨è¾¾èƒ½åŠ›ï¼Œé€‚åˆè¾ƒå¤§è§„æ¨¡å›¾åƒåˆ†ç±»ä»»åŠ¡ | å‚æ•°é‡å¤§ï¼Œè®¡ç®—èµ„æºæ¶ˆè€—è¾ƒé«˜ |
| ResNet-18 | é‡‡ç”¨æ®‹å·®ç»“æ„ï¼Œé¿å…äº†æ·±åº¦å¢åŠ å¸¦æ¥çš„æ¢¯åº¦æ¶ˆå¤±é—®é¢˜ï¼Œä½¿æ·±å±‚ç½‘ç»œçš„è®­ç»ƒå˜å¾—ç¨³å®šã€‚ | æ·±å±‚ç»“æ„è¡¨è¾¾èƒ½åŠ›å¼ºï¼Œé€‚åˆå¤æ‚æ•°æ®é›†ï¼Œæ”¶æ•›é€Ÿåº¦å¿« | å¯¹å°æ•°æ®é›†æœ‰æ—¶å¯èƒ½ä¼šè¿‡æ‹Ÿåˆï¼Œè®¡ç®—é‡ç›¸å¯¹è¾ƒå¤§ |

### ViT  
è®­ç»ƒå‚æ•°ï¼š  
```bash
lr: 5e-5  
optimizer: Adam  
Loss: NLLLoss  
activation: GELU(é¿å…reluä½¿å¾—æ¨¡å‹æœ‰æ•ˆç¥ç»å…ƒè¿‡å°‘)  
emb_size: 128  
attention_head: 8  
layer_num: 1  
```
è®­ç»ƒæ—¶æ˜æ˜¾è§‚æŸ¥åˆ°è®­ç»ƒå‰æœŸéœ€è¦é¢„çƒ­ï¼Œåœ¨0.5ä¸ªepochåAccå¼€å§‹è¿…é€Ÿå¢åŠ ï¼Œå¹¶åœ¨10ä¸ªepochåè¶‹äºå¹³ç¨³ã€‚  
å¦‚æœä½¿ç”¨PyTorchè‡ªå¸¦çš„Transformerå±‚ï¼Œéœ€è¦æ³¨æ„æ·»åŠ å‚æ•°batch_first=True,æ‰èƒ½æ­£ç¡®è®¡ç®—ã€‚
> å®éªŒ
- ä¸ºä»€ä¹ˆTransformerå…¬å¼ä¸­è¦é™¤ä»¥sqrt(d)?  
åœ¨ç½‘ä¸ŠæŸ¥æ‰¾çš„ç»“æœåŸºæœ¬ä¸Šéƒ½æ˜¯ä»QKå†…ç§¯æ–¹å·®å½’ä¸€åŒ–çš„è§’åº¦è¯´æ˜çš„ï¼Œå³è®¤ä¸ºé™¤ä»¥sqrt(d)åå¯ä½¿å¾—å†…ç§¯æ›´å‡åŒ€ï¼Œé¿å…è®­ç»ƒä¸­æ”¶æ•›æ…¢/ä¸æ”¶æ•›ç­‰æƒ…å½¢ã€‚**ä½†åœ¨å®é™…æµ‹è¯•æ—¶å‘ç°å»æ‰è¿™ä¸€éƒ¨åˆ†åå¯¹å®éªŒç»“æœå‡ ä¹æ²¡æœ‰å½±å“ï¼ˆæ— è®ºæ˜¯æ”¶æ•›é€Ÿåº¦è¿˜æ˜¯bestAccuracyï¼‰**ï¼Œå¯èƒ½æ˜¯å› ä¸ºMNISTä»»åŠ¡å¤ªè¿‡ç®€å•ã€‚  

## å®è·µå››ï¼šTiny-VOC å›¾åƒåˆ†ç±»  
ä»»åŠ¡æ–‡ä»¶å¤¹ VOC 
### è®­ç»ƒå‰å¤„ç†  
ä½¿ç”¨è„šæœ¬å°†åˆ†å‰²ç±»æ•°æ®æ ‡æ³¨è½¬ä¸ºåˆ†ç±»æ•°æ®æ ‡æ³¨ï¼Œå¹¶å°†ä¸åŒå°ºå¯¸çš„è®­ç»ƒå›¾ç‰‡è½¬ä¸º224x224 PNGæ ¼å¼ã€‚  
æ•°æ®æ ·å¼å¦‚ä¸‹ï¼š  
```Bash
00000,0,1
00001,4
00002,1
#index,class0,class1,...
```
ç»è¿‡ç»Ÿè®¡å‘ç°Tiny-VOCæä¾›æ•°æ®é›†åªæœ‰**äº”**ä¸ªç±»åˆ«ï¼ˆè€ŒéPPTä¸­æ‰€è¯´20ä¸ªï¼‰ï¼š  
car,plane,cat,people,bird 

### æ•°æ®é¢„å¤„ç†  
ç»è¿‡å®æµ‹å‘ç°ç½‘ç»œå¾ˆå®¹æ˜“äº§ç”Ÿè¿‡æ‹Ÿåˆç°è±¡ï¼Œæ‰€ä»¥é‡‡ç”¨æ•°æ®å¢å¼ºï¼ŒBatchNormï¼ŒDropoutç­‰æ‰‹æ®µå¢å¼ºç½‘ç»œæ³›åŒ–èƒ½åŠ›ã€‚~~ç”±äºæ²¡æœ‰è¶³å¤Ÿçš„ç®—åŠ›ï¼Œæ— æ³•è¿›è¡Œè¶…å‚æ•°æœç´¢ã€‚~~

### è®­ç»ƒ  
å¯¹éViTæ¶æ„æ¨¡å‹é‡‡ç”¨ç»Ÿä¸€å­¦ä¹ ç‡ä¸ä¼˜åŒ–å™¨ã€‚  
```
lr: 1e-3 (ViT: 5e-5) 
optimizer: Adam  
Epoch: Unfixed (Train until converge)  
```
ç½‘ç»œå‚æ•°é‡åŠè®­ç»ƒæƒ…å†µå¦‚ä¸‹ï¼š  

| Model     | Parameters | TestAcc | Precision | Recall | F1     |  
|-----------|------------|---------|-----------|--------|--------|  
| LeNet     | 21M        | 0.8906  | 0.7703    | 0.7454 | 0.7577 |  
| VGG       | 432M       | 0.8828  | 0.7716    | 0.7386 | 0.7547 |  
| **Res18** | 43M        | 0.9153  | 0.8512    | 0.8114 | 0.8308 |  
| ViT       | 83M/169M   | 0.8525  | 0.7141    | 0.6878 | 0.7007 |  

å®é™…ä¸Šï¼ŒViTæ¨¡å‹å³ä½¿ç»è¿‡åå¤ä¿®æ”¹æˆ‘ä¹Ÿæ— æ³•ä½¿æ¨¡å‹æ”¶æ•›åˆ°ä¸€ä¸ªæ¯”è¾ƒè‰¯å¥½çš„è¡¨ç°ğŸ˜‚æ¨æµ‹æœ‰ä»¥ä¸‹åŸå› ï¼š
1. æ•°æ®é›†è§„æ¨¡è¾ƒå°ï¼Œæ— æ³•å……åˆ†è®­ç»ƒã€‚
2. ViTéœ€è¦è®­ç»ƒè¾ƒå¤šepochæ‰èƒ½å¼€å§‹æ”¶æ•›ã€‚
3. ViTå¯¹è¶…å‚æ•°è®¾ç½®è¾ƒä¸ºæ•æ„Ÿã€‚
4. éœ€è¦è¾ƒå¤§çš„æ¨¡å‹æ¶æ„  

ç”±äºç®—åŠ›é—®é¢˜åªèƒ½æš‚æ—¶æç½®ã€‚
### PR-Curve  
å¯ä»¥çœ‹å‡ºå…¶å®åªæœ‰ResNet18çš„PRæ›²çº¿è¡¨ç°å°šå¯ã€‚è¿™äº›æ¨¡å‹å¯èƒ½éƒ½è¿˜è¿œæœªæ”¶æ•›è‡³æœ€ä¼˜ã€‚
LeNet:
![LeNet](VOC/img/PR_LeNet.png)  
VGG:
![VGG](VOC/img/PR_VGG.png)
ResNet18:
![Res18](VOC/img/PR_Res18_2.png)
ViT:
![ViT](VOC/img/PR_ViT_large.png)
![ViT](VOC/img/PR_ViT_tiny.png)


### ç»“è®º
åœ¨Tiny-VOCæ•°æ®é›†ä¸Šï¼Œä¼ ç»Ÿå·ç§¯ç¥ç»ç½‘ç»œï¼ˆResNetï¼‰è¡¨ç°~~å¯èƒ½~~ä¼˜äºViTæ¨¡å‹ã€‚  
### ä¸€äº›å‘ç°  
- åœ¨é¢å¯¹è¿‡æ‹Ÿåˆæƒ…å½¢æ—¶ï¼Œå¯ä»¥é€‰æ‹©å¢å¼ºæ¨¡å‹æ³›åŒ–èƒ½åŠ›æˆ–é™ä½æ¨¡å‹æ‹Ÿåˆèƒ½åŠ›ã€‚å®é™…ä¸Šåœ¨ç½‘ä¸Šæœç´¢ä¸­äº†è§£åˆ°ï¼Œå¤§éƒ¨åˆ†éƒ½å»ºè®®å¢å¼ºæ³›åŒ–èƒ½åŠ›è€Œéæœ‰æ„å‡å°æ¨¡å‹æ¶æ„ã€‚å…¶å®åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ä¹Ÿæœ‰æ‰€ä½“ä¼šã€‚å¤§æ¨¡å‹å¯èƒ½åœ¨æœ€åˆä¼šäº§ç”Ÿè¿‡æ‹Ÿåˆçš„é—®é¢˜ï¼Œä½†å¾ˆå¤šæ—¶å€™åœ¨åšæŒåå¤è®­ç»ƒåtestLossä¹Ÿä¼šçªç„¶ä¸‹é™ï¼Œå³æ¨¡å‹æ³›åŒ–èƒ½åŠ›å¢å¼ºã€‚  
- ResNet å’Œ ViT æ¨¡å‹åœ¨è®­ç»ƒæ—¶Lossæ—¶å¸¸å‡ºç°æŒ¯è¡ç°è±¡ï¼Œæ¨æµ‹å¯èƒ½æ˜¯å­¦ä¹ ç‡é—®é¢˜ã€‚  

## ä¸€ä¸ªå®éªŒ 
ä»»åŠ¡æ–‡ä»¶å¤¹ visualize_halfmoon
### æ¿€æ´»å‡½æ•°ä¸éçº¿æ€§æ€§ 
å¿ƒè¡€æ¥æ½®æƒ³åˆ°relu+MLP=åˆ†æ®µçº¿æ€§å‡½æ•°ï¼Œæƒ³è¦å¯è§†åŒ–è€ƒå¯Ÿä¸€ä¸‹ä¸åŒæ¿€æ´»å‡½æ•°å¯¹ç¥ç»ç½‘ç»œçš„éçº¿æ€§è¡¨è¾¾èƒ½åŠ›æœ‰ä½•å½±å“ã€‚ 
### å°è¯•ç¯å¢ƒ 
- pytorch  
- halfmoonæ•°æ®é›†
- MLP 2->10->10->1 å›ºå®šæ¶æ„  
- AdamWä¼˜åŒ–å™¨ 
### å°è¯•ç»„åˆ 
æˆåŠŸæ‹Ÿåˆï¼š 
- abs x abs 
- exp x exp 
- exp x cos 
- sin x sin 
- x^2  
- relu 
- sigmoid 
- sort 
- permute   

æ— æ³•æ‹Ÿåˆï¼š 
- *1/x* x *1/x*
- *tan* x *tan*
- *sgn* 
### å°è¯•ç»“æœ
abs x abs
![halfmoon](visualize_halfmoon/result/abs.gif)
exp x exp
![halfmoon](visualize_halfmoon/result/exp.gif)
exp x cos
![halfmoon](visualize_halfmoon/result/exp_cos.gif)
sin x sin
![halfmoon](visualize_halfmoon/result/sin.gif)
permute
![halfmoon](visualize_halfmoon/result/permute.gif)
sort
![halfmoon](visualize_halfmoon/result/sort.gif)
x^2
![halfmoon](visualize_halfmoon/result/square.gif)
relu
![halfmoon](visualize_halfmoon/result/relu.gif)
sigmoid
![halfmoon](visualize_halfmoon/result/sigmoid.gif)
### ç»“è®º  
ä»¤æˆ‘æ¯”è¾ƒæƒŠè®¶çš„æ˜¯å¯¹ä¸Šä¸€å±‚è¾“å…¥çš„**æ’åº**ä¹Ÿèƒ½å¸¦æ¥éçº¿æ€§æ€§ï¼Œæ ¹æ®ä¸Šä¸€å±‚è¾“å…¥çš„å¤§å°å…³ç³»çš„**permute**ä¹Ÿå¯æ”¶æ•›ã€‚   
```Python
# sort
def forward(self, x):
    x = self.fc1(x)
    x, _ = torch.sort(x,dim=-1)
    x = self.fc2(x)
    x = self.fc3(x)
    return x
```
```Python
# permute
def forward(self, x):
    x = self.fc1(x)
    _, indices = torch.sort(x,dim=-1)
    x = torch.gather(self.fc2(x), dim=-1, index=indices)
    x = self.fc3(x)
    return x
```
æ®æ­¤æˆ‘è§‰å¾—æ¿€æ´»å‡½æ•°ä¸»è¦å†³å®šç½‘ç»œçš„æ³›åŒ–æ–¹å‘ï¼Œè€Œå¯¹è®­ç»ƒæ•°æ®çš„æ‹Ÿåˆèƒ½åŠ›ä¸»è¦æ¥è‡ªäºåå‘ä¼ æ’­ç®—æ³•ï¼ˆå½“ç„¶æ¿€æ´»å‡½æ•°çš„æ€§æ€ä¸èƒ½å¤ªå·®åŠ²ï¼‰ã€‚ä¸çŸ¥é“æœ‰æ²¡æœ‰è¿™æ–¹é¢çš„æ–‡ç« ğŸ˜‚ 
